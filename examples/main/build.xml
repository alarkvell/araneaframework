<?xml version="1.0" encoding="UTF-8"?>

<project basedir="." default="build" name="Aranea Main Example"> 
	<property environment="env" />
	
	<!--Set the classpath-->
	<path id="classpath">
		<fileset dir="../lib" includes="**/*.jar" />
		<fileset dir="../../lib" includes="**/*.jar" />
		<fileset dir="../.." includes="dist/aranea.jar"/>
		<fileset dir="../.." includes="examples/common/dist/aranea-examples-common.jar"/>
	</path>
	
	<!--Set the Jetty classpath-->
	<path id="classpath.jetty">
		<fileset dir="../lib/jetty" includes="*.jar" />
		<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
	</path>
	
	<taskdef
		name="webdoclet"
		classname="xdoclet.modules.web.WebDocletTask"
		classpathref="classpath"
	/>
	
	<!-- Clean up build system results -->
	<target name="clean" description="Clean up build system results">
        <delete dir="war/WEB-INF/classes" failonerror="false"/>
        <delete dir="war/WEB-INF/lib" failonerror="false"/>	
		<delete dir="war/src" failonerror="false"/>	
		<delete dir="war/jsp" failonerror="false"/>
		<delete dir="dist" failonerror="false"/>	
        <delete dir="tmp" failonerror="false"/>
	</target>
	
	<!-- Initialize the build system -->
	<target name="init">
		<mkdir dir="war/WEB-INF/classes" />
		<mkdir dir="war/WEB-INF/lib" />		
	</target>
	
	<path id="classpath.hibernate">
		<fileset dir="../lib/hibernate" includes="*.jar" />
	</path>
	
	<taskdef name="hibernatedoclet" classname="xdoclet.modules.hibernate.HibernateDocletTask">
		<classpath refid="classpath" />
	</taskdef>
		
	<!-- Creates Hibernate mappings from Xdoclet -->	
	<target name="xdoclet.hibernate" depends="init" description="Creates Hibernate mappings from Java files (Xdoclet)">
		<hibernatedoclet destdir="war/WEB-INF/classes/mappings" excludedtags="@version,@author,@todo"
			force="false" mergedir="war/WEB-INF" verbose="true">
			<fileset dir="src">
				<include name="**/model/*.java" />
			</fileset>
			<packageSubstitution packages="org.araneaframework.example.main.business.model" substituteWith="." useFirst="true" />
			<hibernate version="3.0" />
		</hibernatedoclet>
	</target>
	
	<!-- Create WAR -->
	<target name="war" depends="build" description="Build the ready-to-deploy war archive">
		<mkdir dir="dist"/>
		<war destfile="dist/aranea-template-app.war" webxml="war/WEB-INF/web.xml">
			<lib dir="war/WEB-INF/lib" excludes="jasper*"/>
			<classes dir="war/WEB-INF/classes"/>
			<zipfileset dir="war/WEB-INF" includes="*" excludes="web.xml,jetty-web.xml" prefix="WEB-INF"/>
			<zipfileset dir="war/WEB-INF/jsp" prefix="WEB-INF/jsp"/>
			<zipfileset dir="war/jsp" prefix="jsp"/>
			<zipfileset dir="war/src" prefix="src"/>
		</war>
	</target>

	<!-- Build the code -->
	<target name="build" depends="xdoclet.hibernate,compile" description="Build the code">
		<copy todir="war/WEB-INF/lib" flatten="true">
			<fileset dir="../lib">
				<include name="**/*.jar" />
				<exclude name="jetty/*jar" />
			</fileset>
			<fileset dir="../../lib">
				<include name="**/*.jar" />
				<exclude name="j2ee.jar" />
			</fileset>
			<fileset file="../../dist/aranea.jar"/>
			<fileset file="../../examples/common/dist/aranea-examples-common.jar"/>					
		</copy>
		<copy todir="war/WEB-INF/classes">
			<fileset dir=".." includes="log4j.xml"/>
		</copy>
		<copy todir="war/src/">
			<fileset dir="src" includes="**/*"/>
		</copy>
		<copy todir="war/jsp/">
			<fileset dir="war/WEB-INF/jsp" includes="**/*.jsp"/>
		</copy>
		  <move todir="war/jsp/" includeemptydirs="false">
		    <fileset dir="war/jsp/"/>
		    <mapper type="glob" from="*.jsp" to="*.xml"/>
		  </move>
	</target>
	
	<target name="compile" depends="init">
		<!--Compile Java source files-->
		<javac destdir="war/WEB-INF/classes"
			debug="on"
			debuglevel="lines,vars,source"
			encoding="utf-8"
			target="1.3"
			source="1.3"
			srcdir="src"
			includes="**/*.java"
			classpathref="classpath"
		/>
	</target>	
		

	<!-- Starts standalone server -->
	<target name="run-app-only" description="Run in standalone container">
		<mkdir dir="tmp/jsp" /> 
		<java classname="org.mortbay.jetty.Server" dir="war" fork="yes">
			<!-- jvmarg line="-Xrunyjpagent"/ -->
			<arg value="../jetty.xml"/>
			<classpath>
				<pathelement location="war/WEB-INF/classes" />
				<path refid="classpath" />
				<path refid="classpath.jetty" />
			</classpath>
		</java>
	</target>
	
	<target name="run-app" depends="build, run-app-only" description="Build and run in standalone container"/>
	
	<!-- #### HSQLDB #### -->
	
	<!-- Run database -->
	<target name="run-database" description="Run database">
		<mkdir dir="data" />
		
		<java classname="org.hsqldb.Server" dir="data" fork="yes">
			<classpath>
				<pathelement location="../lib/hsqldb/hsqldb.jar" />
			</classpath>
			<arg line="-database.0 'templateapp' -dbname.0 'templateapp'" /> 
		</java>
	</target>

	<!-- Run database manager -->
	<target name="run-database-manager" description="Run database manager">
		<java classname="org.hsqldb.util.DatabaseManagerSwing" dir="data" fork="yes">
			<classpath>
				<pathelement location="../lib/hsqldb/hsqldb.jar" />
			</classpath>
      <arg line="--user sa --url jdbc:hsqldb:hsql://localhost/templateapp" />
		</java>				
	</target>
</project>