<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="build-all" name="Aranea"> 
	<description>
		Code build script.
	</description>
	
	<property file="version.properties"/>
	
	<property name="project.title" value="Aranea"/>
	
	<!--Set the classpath-->
	<path id="classpath">
		<fileset dir="lib" includes="**/*.jar"/>
	</path>
	
	<taskdef
		name="webdoclet"
		classname="xdoclet.modules.web.WebDocletTask"
		classpathref="classpath"
	/>
	
	<!-- Clean up build system results -->
	<target name="clean-all" depends="clean"  description="Clean up build system results">
		<ant dir="template" target="clean" inheritall="false"/>
		<ant dir="examples/main" target="clean" inheritall="false"/>
		<ant dir="examples/serviceHelloWorld" target="clean" inheritall="false"/>
		<ant dir="examples/serviceHelloName" target="clean" inheritall="false"/>
		<ant dir="examples/widgetQuickStart" target="clean" inheritall="false"/>
	</target>
	
	<!-- Clean up build system results -->
	<target name="clean" description="Clean up build system results">
		<delete dir="build" failonerror="false"/>
		<delete dir="dist" failonerror="false"/>
	</target>
	
	<!-- Initialize the build system -->
	<target name="init">
		<mkdir dir="build" />
	</target>
	
	<!-- Build the code -->
	<target name="build" depends="tld, jar" description="Build the code">
	</target>
	
	<target name="build-all" depends="build" description="Build the code and examples">
		<ant dir="template" target="build" inheritall="false"/>
		<ant dir="examples/main" target="build" inheritall="false"/>	
		<ant dir="examples/serviceHelloWorld" target="build" inheritall="false"/>
		<ant dir="examples/serviceHelloName" target="build" inheritall="false"/>
		<ant dir="examples/widgetQuickStart" target="build" inheritall="false"/>
	</target>
	
	<target name="tld-check">
		<uptodate property="tld-check.uptodate" targetfile="build/tmp/presentation/META-INF/aranea-presentation.tld">
			<srcfiles dir="src/org/araneaframework/jsp"/>
		</uptodate>
	</target>
	
	<target name="tld" depends="tld-check,init" unless="tld-check.uptodate">	
		<mkdir dir="build/tmp/presentation/META-INF" />
		
		<webdoclet destdir="build/tmp/presentation/META-INF"
		>
			<fileset dir="src"/>
			
			<jsptaglib validatexml="true"
				shortName="aui"
				filename="aranea-presentation.tld"
				uri="http://araneaframework.org/tag-library/standard"
				description="Aranea User Interface Tag Library"
			/>
		</webdoclet>
	</target>	
	
	<target name="dist">		
		<mkdir dir="build/tmp/dist"/>

		<antcall target="clean-all"/>
		<ant dir="doc/reference" target="clean" inheritall="false"/>
		<ant dir="doc/tutorial" target="clean" inheritall="false"/>
		<ant dir="doc/white-paper" target="clean" inheritall="false"/>
		<mkdir dir="dist"/>

		<copy todir="build/tmp/dist">
			<fileset dir=".">
				<include name="src/**/*"/>
				<include name="tests/**/*"/>
				<include name="etc/**/*"/>
				<include name="examples/**/*"/>
				<include name="template/**/*"/>
				<include name="tests/**/*"/>
				<include name="lib/**/*"/>
				<include name="build.xml"/>
				<include name="LICENSE"/>
				<include name="NOTICE"/>
				<include name="README"/>

				<exclude name="CVS/**/*"/>
				<exclude name="**/*lck"/>
			</fileset>     
		</copy> 

		<antcall target="build-all"/>
		<ant dir="doc/reference" target="clean" inheritall="false"/>
		<ant dir="doc/tutorial" target="clean" inheritall="false"/>
		<ant dir="doc/white-paper" target="clean" inheritall="false"/>
			
		<antcall target="doc"/>
    
		<mkdir dir="build/tmp/dist/dist"/>    

		<copy todir="build/tmp/dist/dist">
			<fileset dir="dist">
				<include name="*.jar"/>
			</fileset>     
		</copy>     

		<copy todir="build/tmp/dist">
			<fileset dir="dist">
				<include name="doc/**/*"/>
			</fileset>     
		</copy>
		
		<mkdir dir="build/tmp/dist/template/dist"/>
		
		<copy todir="build/tmp/dist/template/dist">
			<fileset dir="template/dist">
				<include name="*"/>
			</fileset>     
		</copy>
		
		<property name="distname" value="araneaframework-${araneaframework.version}"/>
		<zip destfile="dist/${distname}.zip">
				<zipfileset dir="build/tmp/dist" prefix="${distname}"/>
		</zip>
	</target>
	
	<target name="compile" depends="init">
		<mkdir dir="build/classes" />
		
		<!--Compile Java source files-->
		<javac destdir="build/classes"
			debug="on"
			debuglevel="lines,vars,source"
			encoding="utf-8"
			compiler="javac1.3"
			target="1.3"
			source="1.3"
			srcdir="src"
			deprecation="yes"
		>
			<classpath refid="classpath"/>
			<include name="**/*.java" />
		</javac>
	</target>
	
	<target name="jar" depends="compile">
		<mkdir dir="dist" />
		
		<jar destfile="dist/aranea-core.jar" compress="true">
			<fileset dir="build/classes">
			  <include name="org/araneaframework/*"/>
				<include name="org/araneaframework/core/**/*"/>								
			</fileset>
		</jar>
		
		<jar destfile="dist/aranea-framework.jar" compress="true">
			<fileset dir="build/classes">
				<include name="org/araneaframework/framework/**/*"/>												
			</fileset>
		</jar>		
		
		<jar destfile="dist/aranea-servlet.jar" compress="true">
			<fileset dir="build/classes">							
			  <include name="org/araneaframework/servlet/**/*"/>						
			</fileset>
		</jar>			
		
		<jar destfile="dist/aranea-backend.jar" compress="true">
			<fileset dir="build/classes">
				<include name="org/araneaframework/backend/**/*"/>			
			</fileset>
		</jar>
		
		<jar destfile="dist/aranea-uilib.jar" compress="true">
			<fileset dir="build/classes">
				<include name="org/araneaframework/uilib/**/*"/>			
			</fileset>
      <fileset dir="etc" includes="resource/**/*"/>  
		</jar>	
		
		<jar destfile="dist/aranea-spring.jar" compress="true">
			<fileset dir="build/classes">
				<include name="org/araneaframework/ioc/spring/**/*"/>			
			</fileset>
			<fileset dir="etc" includes="spring-property-conf/**/*"/>
		</jar>	
		
		<jar destfile="dist/aranea-jsp.jar" compress="true">
			<fileset dir="build/classes">
				<include name="org/araneaframework/jsp/**/*"/>			
			</fileset>
			<fileset dir="etc" includes="js/**/*"/>
			<fileset dir="build/tmp/presentation" includes="META-INF/**/*"/>
		</jar>	
		
		<jar destfile="dist/aranea.jar" compress="true">
			<fileset dir="build/classes">
			  <include name="org/araneaframework/**/*"/>		
			</fileset>
			<fileset dir="etc"/>
			<fileset dir="build/tmp/presentation" includes="META-INF/**/*"/>
		</jar>	
		
		
	</target>
	
	<target name="javadoc">
		<mkdir dir="dist/doc/javadoc/" />
		<javadoc packagenames="org.araneaframework.*" sourcepath="src" destdir="dist/doc/javadoc/"/>
	</target>
	
	<!-- Build internal documentation -->
	<target name="doc" depends="init, javadoc" description="Build internal documentation">
		<ant target="build" dir="doc/reference" />
		<ant target="build" dir="doc/white-paper" /> 
		<ant target="build" dir="doc/tutorial" />     
	</target>
	
	<!-- test the system -->
	<target name="run-tests" depends="init, build" description="Run the junit tests">
		<ant target="run-tests" dir="tests"/>
	</target>
</project>
